{% extends "base.html" %}

{% block title %}LegalAdviser-AI - Chat{% endblock %}

{% block content %}
<div class="flex h-[calc(100vh-4rem)] bg-white overflow-hidden font-sans">
    <!-- Sidebar (History) -->
    <div id="chat-sidebar"
        class="w-[260px] bg-gray-50 border-r border-gray-200 flex flex-col hidden md:flex z-20 fixed md:relative h-full transition-transform transform -translate-x-full md:translate-x-0">

        <!-- New Chat Button -->
        <div class="p-3">
            <button id="new-chat-btn"
                class="w-full bg-white hover:bg-gray-100 text-gray-700 text-sm font-medium py-2.5 px-3 rounded-lg flex items-center justify-between border border-gray-200 transition-all shadow-sm hover:shadow-md group">
                <div class="flex items-center gap-2">
                    <span class="material-icons text-gray-400 group-hover:text-gray-600 text-[18px]">add</span>
                    <span>New Chat</span>
                </div>
                <span class="material-icons text-gray-400 group-hover:text-gray-600 text-[18px]">edit_square</span>
            </button>
        </div>

        <!-- History List -->
        <div class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar" id="history-list">
            <!-- History items injected here -->
        </div>

        <!-- User Profile / Settings (Mock) -->
        <div class="p-3 border-t border-gray-200">
            <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors">
                <div
                    class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold text-xs">
                    U
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-700 truncate">User</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col h-full relative w-full md:w-auto bg-white">
        <!-- Mobile Header -->
        <div
            class="md:hidden h-14 bg-white border-b border-gray-200 flex items-center px-4 justify-between flex-shrink-0 z-20">
            <div class="flex items-center gap-2">
                <button id="sidebar-toggle" class="text-gray-500 p-1 rounded-md hover:bg-gray-100">
                    <span class="material-icons">menu</span>
                </button>
                <span class="font-semibold text-gray-700">LegalAdviser-AI</span>
            </div>
            <button id="mobile-new-chat" class="text-gray-500 p-1 rounded-md hover:bg-gray-100">
                <span class="material-icons">add</span>
            </button>
        </div>

        <!-- Messages Container -->
        <div id="chat-container" class="flex-1 overflow-y-auto w-full scroll-smooth">
            <div id="messages-div" class="max-w-3xl mx-auto px-4 py-8 space-y-8 min-h-full flex flex-col justify-start">
                <!-- Welcome Message -->
                <div
                    class="flex flex-col items-center justify-center h-[60vh] text-center space-y-6 animate-fade-in-up">
                    <div
                        class="w-16 h-16 rounded-full bg-white border border-gray-200 flex items-center justify-center shadow-sm">
                        <span class="material-icons text-indigo-600 text-3xl">gavel</span>
                    </div>
                    <div class="space-y-2 max-w-md">
                        <h2 class="text-2xl font-semibold text-gray-800">How can I help you today?</h2>
                        <p class="text-gray-500 text-sm">
                            I'm your AI Legal Assistant for Indian Laws. Ask me about the IPC, CrPC, BNS, or RTI Act.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="w-full bg-white p-4 pb-6 flex-shrink-0 z-20">
            <div class="max-w-3xl mx-auto relative">
                <div
                    class="relative flex items-end gap-2 bg-gray-100 border border-gray-200 rounded-[2rem] p-3 shadow-sm focus-within:ring-2 focus-within:ring-indigo-100 focus-within:border-indigo-300 transition-all">

                    <textarea id="user-input" rows="1"
                        class="w-full bg-transparent border-0 text-gray-900 text-base focus:ring-0 focus:outline-none p-2 resize-none max-h-48 overflow-y-auto placeholder-gray-500"
                        placeholder="Message LegalAdviser-AI..."
                        style="min-height: 24px; max-height: 200px;"></textarea>

                    <button id="send-btn"
                        class="p-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed self-end">
                        <span class="material-icons text-[20px]">arrow_upward</span>
                    </button>
                </div>
                <p class="text-center text-[11px] text-gray-400 mt-3">
                    LegalAdviser-AI can make mistakes. Verify important information.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const historyList = document.getElementById('history-list');
    const newChatBtn = document.getElementById('new-chat-btn');
    const mobileNewChatBtn = document.getElementById('mobile-new-chat');
    const messagesDiv = document.getElementById('messages-div');
    const chatContainer = document.getElementById('chat-container');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const chatSidebar = document.getElementById('chat-sidebar');

    let currentSessionId = null;

    // Auto-resize textarea
    userInput.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        if (this.value === '') this.style.height = '44px';
    });

    // --- History Management ---
    function getHistory() {
        const history = localStorage.getItem('chat_history');
        return history ? JSON.parse(history) : [];
    }

    function saveHistory(history) {
        localStorage.setItem('chat_history', JSON.stringify(history));
        renderHistory();
    }

    function updateHistory(sessionId, title) {
        let history = getHistory();
        history = history.filter(h => h.id !== sessionId);
        history.unshift({ id: sessionId, title: title, timestamp: Date.now() });
        if (history.length > 20) history.pop();
        saveHistory(history);
    }

    function renderHistory() {
        const history = getHistory();
        historyList.innerHTML = '';

        // Group by time (Today, Yesterday, etc.) - Simplified for now
        if (history.length === 0) {
            historyList.innerHTML = '<div class="text-center text-gray-400 text-xs mt-4">No recent chats</div>';
            return;
        }

        const label = document.createElement('div');
        label.className = 'px-3 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider';
        label.textContent = 'Recent';
        historyList.appendChild(label);

        history.forEach(item => {
            const div = document.createElement('div');
            div.className = `group flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer text-sm transition-colors ${item.id === currentSessionId ? 'bg-gray-200 text-gray-900' : 'text-gray-600 hover:bg-gray-100'}`;
            div.innerHTML = `
                <span class="flex-1 truncate">${item.title}</span>
                <button class="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 p-1 rounded" onclick="deleteSession('${item.id}', event)">
                    <span class="material-icons text-[14px]">delete</span>
                </button>
            `;
            div.onclick = (e) => {
                if (!e.target.closest('button')) loadSession(item.id);
            };
            historyList.appendChild(div);
        });
    }

    function deleteSession(sessionId, event) {
        event.stopPropagation();
        if (confirm('Delete this chat?')) {
            let history = getHistory().filter(h => h.id !== sessionId);
            saveHistory(history);
            if (currentSessionId === sessionId) startNewChat();
        }
    }

    async function loadSession(sessionId) {
        currentSessionId = sessionId;
        renderHistory();

        if (window.innerWidth < 768) toggleSidebar();

        messagesDiv.innerHTML = ''; // Clear current view

        try {
            const response = await fetch(`/chat/${sessionId}/history`);
            if (response.ok) {
                const history = await response.json();
                history.forEach(msg => appendMessage(msg.role, msg.content, false));
            } else {
                appendMessage('model', 'This session has expired or was not found.', false);
                let localHistory = getHistory().filter(h => h.id !== sessionId);
                saveHistory(localHistory);
            }
        } catch (error) {
            console.error('Error loading session:', error);
        }
    }

    function startNewChat() {
        currentSessionId = null;
        messagesDiv.innerHTML = `
        <div class="flex flex-col items-center justify-center h-[60vh] text-center space-y-6 animate-fade-in-up">
            <div class="w-16 h-16 rounded-full bg-white border border-gray-200 flex items-center justify-center shadow-sm">
                <span class="material-icons text-indigo-600 text-3xl">gavel</span>
            </div>
            <div class="space-y-2 max-w-md">
                <h2 class="text-2xl font-semibold text-gray-800">How can I help you today?</h2>
                <p class="text-gray-500 text-sm">
                    I'm your AI Legal Assistant for Indian Laws. Ask me about the IPC, CrPC, BNS, or RTI Act.
                </p>
            </div>
        </div>`;
        renderHistory();
        userInput.focus();
    }

    // --- Chat Logic ---
    function appendMessage(role, content, animate = true) {
        const isUser = role === 'user';

        // Remove welcome screen if it exists
        if (messagesDiv.querySelector('.text-center')) {
            messagesDiv.innerHTML = '';
        }

        const div = document.createElement('div');
        div.className = `flex gap-4 ${animate ? 'animate-fade-in-up' : ''} ${isUser ? 'justify-end' : 'justify-start'}`;

        const avatar = isUser
            ? `` // No avatar for user in this design, just bubble
            : `<div class="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center flex-shrink-0 shadow-sm mt-1">
                <span class="material-icons text-indigo-600 text-sm">gavel</span>
               </div>`;

        const bubbleClass = isUser
            ? 'bg-gray-100 text-gray-800 rounded-3xl px-5 py-3 max-w-[85%] md:max-w-[75%]'
            : 'text-gray-800 max-w-full prose prose-slate prose-p:leading-relaxed prose-a:text-indigo-600 prose-strong:text-gray-900';

        const formattedContent = isUser ? content : marked.parse(content);

        div.innerHTML = `
            ${!isUser ? avatar : ''}
            <div class="${bubbleClass}">
                ${formattedContent}
            </div>
        `;

        messagesDiv.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        userInput.value = '';
        userInput.style.height = '44px'; // Reset height
        appendMessage('user', text);

        // Show loading
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'flex gap-4 animate-fade-in-up justify-start';
        loadingDiv.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center flex-shrink-0 shadow-sm mt-1">
                <span class="material-icons text-indigo-600 text-sm">gavel</span>
            </div>
            <div class="flex items-center space-x-1 mt-3">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-100"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-200"></div>
            </div>`;
        messagesDiv.appendChild(loadingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text, session_id: currentSessionId })
            });

            messagesDiv.removeChild(loadingDiv);

            if (!response.ok) throw new Error('Network response was not ok');

            const data = await response.json();

            if (data.session_id) {
                currentSessionId = data.session_id;
                if (data.session_title) {
                    updateHistory(currentSessionId, data.session_title);
                }
            }

            appendMessage('model', data.reply);
        } catch (error) {
            if (messagesDiv.contains(loadingDiv)) messagesDiv.removeChild(loadingDiv);
            appendMessage('model', 'Sorry, something went wrong. Please try again.');
            console.error('Error:', error);
        }
    }

    // Mobile Sidebar Logic
    function toggleSidebar() {
        if (chatSidebar.classList.contains('hidden')) {
            chatSidebar.classList.remove('hidden');
            chatSidebar.classList.add('flex');
            setTimeout(() => chatSidebar.classList.remove('-translate-x-full'), 10);
        } else {
            chatSidebar.classList.add('-translate-x-full');
            setTimeout(() => {
                chatSidebar.classList.add('hidden');
                chatSidebar.classList.remove('flex');
            }, 300);
        }
    }

    // Event Listeners
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    newChatBtn.addEventListener('click', () => {
        startNewChat();
        if (window.innerWidth < 768) toggleSidebar();
    });
    if (mobileNewChatBtn) {
        mobileNewChatBtn.addEventListener('click', startNewChat);
    }
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', toggleSidebar);
    }

    // Initialize
    renderHistory();
</script>

<style>
    /* Custom Scrollbar for Sidebar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #e5e7eb;
        border-radius: 20px;
    }

    .custom-scrollbar:hover::-webkit-scrollbar-thumb {
        background-color: #d1d5db;
    }
</style>
{% endblock %}
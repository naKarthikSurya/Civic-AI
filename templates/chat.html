{% extends "base.html" %}

{% block title %}LegalAdviser-AI - Chat{% endblock %}

{% block content %}
<div class="flex h-[calc(100vh-4rem)] bg-white overflow-hidden font-sans">
    <!-- Sidebar (History) -->
    <div id="chat-sidebar" class="w-[260px] bg-gray-50 border-r border-gray-200 flex flex-col hidden md:flex z-20">

        <!-- New Chat Button -->
        <div class="p-3">
            <button id="new-chat-btn"
                class="w-full bg-white hover:bg-gray-100 text-gray-800 text-sm font-medium py-2.5 px-3 rounded-lg border border-gray-200 flex items-center justify-center gap-2 transition-colors">
                <span class="material-icons text-[18px]">add</span>
                <span>New chat</span>
            </button>
        </div>

        <!-- History List -->
        <div class="flex-1 overflow-y-auto px-2 space-y-1 custom-scrollbar" id="history-list">
            <!-- History items injected here -->
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col h-full relative">
        <!-- Messages Container -->
        <div id="chat-container" class="flex-1 overflow-y-auto w-full scroll-smooth">
            <div id="messages-div" class="max-w-3xl mx-auto px-4 py-8 space-y-6">
                <!-- Welcome Screen -->
                <div id="welcome-screen"
                    class="flex flex-col items-center justify-center min-h-[60vh] text-center space-y-6">
                    <div
                        class="w-16 h-16 bg-gradient-to-br from-purple-600 to-cyan-600 rounded-2xl flex items-center justify-center shadow-lg">
                        <span class="material-icons text-white text-3xl">gavel</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-900 mb-2">How can I help you today?</h2>
                        <p class="text-gray-600">Ask me anything about Indian law</p>
                    </div>

                    <!-- Suggested Prompts -->
                    <div class="w-full max-w-2xl grid md:grid-cols-2 gap-3 mt-4">
                        <button
                            class="suggested-prompt text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors border border-gray-200"
                            data-prompt="What is IPC Section 420?">
                            <div class="text-sm font-medium text-gray-900">IPC Section 420</div>
                            <div class="text-xs text-gray-600 mt-1">Explain this criminal law provision</div>
                        </button>

                        <button
                            class="suggested-prompt text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors border border-gray-200"
                            data-prompt="How to file an RTI application?">
                            <div class="text-sm font-medium text-gray-900">File RTI Application</div>
                            <div class="text-xs text-gray-600 mt-1">Guide on submitting RTI requests</div>
                        </button>

                        <button
                            class="suggested-prompt text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors border border-gray-200"
                            data-prompt="Differences between IPC and BNS">
                            <div class="text-sm font-medium text-gray-900">IPC vs BNS</div>
                            <div class="text-xs text-gray-600 mt-1">Compare legal codes</div>
                        </button>

                        <button
                            class="suggested-prompt text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors border border-gray-200"
                            data-prompt="How to file an FIR?">
                            <div class="text-sm font-medium text-gray-900">File FIR</div>
                            <div class="text-xs text-gray-600 mt-1">Procedure for filing a complaint</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area - Fixed at bottom -->
        <div class="border-t border-gray-200 bg-white p-4">
            <div class="max-w-3xl mx-auto">
                <div
                    class="flex items-center gap-3 bg-gray-100 rounded-3xl px-4 py-2.5 focus-within:bg-gray-50 transition-colors">
                    <textarea id="user-input" rows="1"
                        class="flex-1 bg-transparent border-0 text-gray-900 text-sm focus:ring-0 focus:outline-none resize-none placeholder-gray-500"
                        placeholder="Message LegalAdviser AI..." style="max-height: 120px;"></textarea>

                    <button id="send-btn"
                        class="p-2 bg-gray-900 hover:bg-gray-800 text-white rounded-full transition-colors disabled:opacity-40 disabled:cursor-not-allowed flex-shrink-0">
                        <span class="material-icons text-[20px]">arrow_upward</span>
                    </button>
                </div>
                <p class="text-center text-[10px] text-gray-500 mt-2">
                    LegalAdviser AI can make mistakes. Always verify important information.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const historyList = document.getElementById('history-list');
    const newChatBtn = document.getElementById('new-chat-btn');
    const messagesDiv = document.getElementById('messages-div');
    const chatContainer = document.getElementById('chat-container');
    const welcomeScreen = document.getElementById('welcome-screen');

    let currentSessionId = null;

    // Auto-resize textarea
    userInput.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // Suggested prompts click handler
    document.querySelectorAll('.suggested-prompt').forEach(btn => {
        btn.addEventListener('click', function () {
            const prompt = this.getAttribute('data-prompt');
            userInput.value = prompt;
            userInput.focus();
            setTimeout(() => sendMessage(), 200);
        });
    });

    // --- History Management ---
    function getHistory() {
        const history = localStorage.getItem('chat_history');
        return history ? JSON.parse(history) : [];
    }

    function saveHistory(history) {
        localStorage.setItem('chat_history', JSON.stringify(history));
        renderHistory();
    }

    function updateHistory(sessionId, title) {
        let history = getHistory();
        history = history.filter(h => h.id !== sessionId);
        history.unshift({ id: sessionId, title: title, timestamp: Date.now() });
        if (history.length > 20) history.pop();
        saveHistory(history);
    }

    function renderHistory() {
        const history = getHistory();
        historyList.innerHTML = '';

        if (history.length === 0) {
            historyList.innerHTML = '<div class="text-center text-gray-400 text-xs py-8 px-3">No conversations yet</div>';
            return;
        }

        history.forEach(item => {
            const div = document.createElement('div');
            div.className = `group flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer text-sm transition-colors ${item.id === currentSessionId ? 'bg-gray-200' : 'hover:bg-gray-100'}`;
            div.innerHTML = `
                <span class="material-icons text-[16px] text-gray-600">chat_bubble_outline</span>
                <span class="flex-1 truncate text-gray-800">${item.title}</span>
                <button class="opacity-0 group-hover:opacity-100 text-gray-500 hover:text-red-600 p-1 rounded" onclick="deleteSession('${item.id}', event)">
                    <span class="material-icons text-[16px]">delete</span>
                </button>
            `;
            div.onclick = (e) => {
                if (!e.target.closest('button')) loadSession(item.id);
            };
            historyList.appendChild(div);
        });
    }

    function deleteSession(sessionId, event) {
        event.stopPropagation();
        if (confirm('Delete this conversation?')) {
            let history = getHistory().filter(h => h.id !== sessionId);
            saveHistory(history);
            if (currentSessionId === sessionId) startNewChat();
        }
    }

    async function loadSession(sessionId) {
        currentSessionId = sessionId;
        renderHistory();
        messagesDiv.innerHTML = '';

        try {
            const response = await fetch(`/chat/${sessionId}/history`);
            if (response.ok) {
                const history = await response.json();
                history.forEach(msg => appendMessage(msg.role, msg.content, false));
            } else {
                appendMessage('model', 'This conversation could not be loaded.', false);
                let localHistory = getHistory().filter(h => h.id !== sessionId);
                saveHistory(localHistory);
            }
        } catch (error) {
            console.error('Error loading session:', error);
        }
    }

    function startNewChat() {
        currentSessionId = null;
        messagesDiv.innerHTML = welcomeScreen.outerHTML;

        document.querySelectorAll('.suggested-prompt').forEach(btn => {
            btn.addEventListener('click', function () {
                const prompt = this.getAttribute('data-prompt');
                userInput.value = prompt;
                userInput.focus();
                setTimeout(() => sendMessage(), 200);
            });
        });

        renderHistory();
        userInput.focus();
    }

    // --- Chat Logic ---
    function appendMessage(role, content, animate = true) {
        const isUser = role === 'user';

        const welcome = messagesDiv.querySelector('#welcome-screen');
        if (welcome) welcome.remove();

        const div = document.createElement('div');
        div.className = `flex gap-4 ${animate ? 'opacity-0 animate-fade-in' : ''}`;

        if (isUser) {
            div.innerHTML = `
                <div class="ml-auto bg-gray-100 text-gray-900 rounded-2xl px-4 py-2.5 max-w-[70%]">
                    <div class="text-sm">${content}</div>
                </div>
            `;
        } else {
            const formattedContent = marked.parse(content);
            div.innerHTML = `
                <div class="flex gap-3 max-w-full">
                    <div class="w-8 h-8 bg-gradient-to-br from-purple-600 to-cyan-600 rounded-lg flex items-center justify-center flex-shrink-0">
                        <span class="material-icons text-white text-[18px]">gavel</span>
                    </div>
                    <div class="flex-1 prose prose-sm prose-slate max-w-none">
                        ${formattedContent}
                    </div>
                </div>
            `;
        }

        messagesDiv.appendChild(div);
        if (animate) {
            setTimeout(() => div.classList.add('opacity-100'), 10);
        }
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        userInput.value = '';
        userInput.style.height = 'auto';
        appendMessage('user', text);

        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'flex gap-3 typing-indicator';
        loadingDiv.innerHTML = `
            <div class="w-8 h-8 bg-gradient-to-br from-purple-600 to-cyan-600 rounded-lg flex items-center justify-center flex-shrink-0">
                <span class="material-icons text-white text-[18px]">gavel</span>
            </div>
            <div class="flex items-center gap-1.5 py-2">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
            </div>
        `;
        messagesDiv.appendChild(loadingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text, session_id: currentSessionId })
            });

            messagesDiv.removeChild(loadingDiv);

            if (!response.ok) throw new Error('Network response was not ok');

            const data = await response.json();

            if (data.session_id) {
                currentSessionId = data.session_id;
                if (data.session_title) {
                    updateHistory(currentSessionId, data.session_title);
                }
            }

            appendMessage('model', data.reply);
        } catch (error) {
            if (messagesDiv.contains(loadingDiv)) messagesDiv.removeChild(loadingDiv);
            appendMessage('model', 'Sorry, something went wrong. Please try again.');
            console.error('Error:', error);
        }
    }

    // Event Listeners
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    newChatBtn.addEventListener('click', startNewChat);

    // Initialize
    renderHistory();
</script>

<style>
    @keyframes fade-in {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in {
        animation: fade-in 0.3s ease-out forwards;
    }
</style>
{% endblock %}